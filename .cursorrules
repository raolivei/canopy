# Canopy - Cursor Rules

## Project Overview
Self-hosted personal finance dashboard combining portfolio, budgeting, and transaction tracking. Runs on Raspberry Pi k3s clusters.

## Project Structure
```
canopy/
├── backend/              # FastAPI backend (Python)
│   ├── api/             # API endpoints
│   ├── models/          # Pydantic models
│   ├── app/             # FastAPI application
│   ├── ingest/          # CSV/OFX import handlers
│   └── services/        # Business logic
├── frontend/            # Next.js frontend (TypeScript)
│   ├── components/      # React components
│   ├── pages/           # Next.js pages
│   └── utils/           # Utility functions
└── k8s/                 # Kubernetes manifests
```

## Code Conventions

### Python (Backend)
- Follow PEP 8
- Use type hints everywhere
- Pydantic models for data validation
- SQLAlchemy for database models
- Use absolute imports: `from backend.api import ...`
- Set `PYTHONPATH` to project root for development

### TypeScript (Frontend)
- Use TypeScript strictly
- Functional components with hooks
- Next.js App Router patterns
- Tailwind CSS for styling
- Use `utils/` for reusable functions

### Git Workflow
- Use conventional commits: `feat:`, `fix:`, `docs:`, `chore:`
- Feature branches: `feature/<name>`
- Keep backend and frontend changes in separate commits when possible

### Kubernetes Manifests
- Namespace: `canopy`
- Resource naming: `canopy-<component>`
- Include resource limits (Raspberry Pi optimized)
- Use ConfigMaps for configuration

## Common Tasks

### Adding Transaction Endpoint
1. Add route in `backend/api/transactions.py`
2. Add Pydantic model in `backend/models/transaction.py`
3. Add database model if needed
4. Update API docs (auto-generated from FastAPI)

### Adding CSV Import Format
1. Add parser in `backend/ingest/csv_parsers.py`
2. Add format detection logic
3. Add example CSV in `examples/`
4. Update `CSV_IMPORT_GUIDE.md`

### Adding Frontend Component
1. Create component in `frontend/components/`
2. Add types if needed
3. Use Tailwind for styling
4. Follow existing component patterns

### Updating Kubernetes Deployment
1. Update manifests in `k8s/`
2. Test: `kubectl apply -f k8s/ --dry-run=client`
3. Update `DEPLOYMENT.md` if needed

## Development Setup

### Backend
```bash
cd backend
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
PYTHONPATH=/path/to/canopy python3 -m uvicorn app.server:app --reload
```

**Why PYTHONPATH?** Python needs to find `backend` module for absolute imports.

### Frontend
```bash
cd frontend
npm install
npm run dev
```

### Testing
```bash
./test_app.sh  # Runs comprehensive tests
```

## Key Design Decisions

### Why Separate Processes?
- Independent scaling
- Different deployment strategies
- Technology fit (Python for data, TypeScript for UI)

### Why Local Storage?
- Privacy: Financial data never leaves control
- Security: No cloud breaches
- Compliance: Data residency requirements

### Why Multi-Currency?
- Modern users have assets across currencies
- Accurate net worth calculation
- Meaningful spending analysis

### Why CSV/OFX Import?
- Most banks don't offer APIs
- Universal formats
- Platform-agnostic

### Why Raspberry Pi Optimized?
- Affordable hardware
- Low power consumption
- 24/7 operation
- Full data control

## Important Notes
- **Self-hosted only** - No cloud dependencies
- **Privacy-first** - All data stored locally
- **Multi-currency** - CAD, USD, BRL, EUR, GBP supported
- **CSV import** - Smart format detection
- **Raspberry Pi** - Optimized for low-power hardware

## Documentation
- `README.md` - Overview and quick start
- `ARCHITECTURE.md` - Design decisions
- `CSV_IMPORT_GUIDE.md` - CSV import documentation
- `MASTER_PROMPT.md` - Complete recreation guide
- `DEPLOYMENT.md` - Kubernetes deployment

